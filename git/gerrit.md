
# Gerrit?
Gerrit 은 Git 기반의 코드 리뷰 시스템, 일정 점수 이상의 코드 리뷰 점수를 얻어야 코드의 변경사항을 적용할 수 있다.

# 네이버에서 코드 리뷰 경험
코드 리뷰는 정형화된 방식으로 이루어지거나 정형화되지 않은 방식으로 이루어진다.

정형화된 방식에서는 다수의 참여자가 여러 단계를 거치는 세밀한 프로세스로 코드 리뷰를 진행한다.
코드의 결함을 발견하는데 효과적이나 절차가 복잡하고 시간이 오래 걸린다.

정형화되지 않은 방식의 코드 리뷰는 검토 과정과 절차가 단순해 일상적인 개발 과정의 일부로 실행할 수 있다.
하지만 정형화되지 않은 방식의 코드 리뷰는 배포 이후에 이루어지는 경우가 많아, 개발 프로세스에서 한발 물러서 있다는 느낌도 들게한다.


네이버에서는 정형화되지 않은 방식의 코드 리뷰의 단순함을 유지하면서도 코드 리뷰를 개발 프로세스의 일부로
만들기 위해 자동화된 코드 리뷰 시스템을 도입했다. 자동화된 코드 리뷰 시스템을 사용하면 
코드 리뷰를 강제해 코드 리뷰를 개발 프로세스의 일부로 만들 수 있다.

# 회의를 통한 코드 리뷰
네이버는 코드의 품질을 높이기 위해 많은 노력을 기울이고 있다.
개발 과정에서 테스트 케이스를 작성해 단위 테스트를 진행하고, 품질의 주요 지표로 코드 커버리지를 사용한다.
전사 표준 코드 스타일을 적요앻 읽기 쉽고 복잡하지 않은 코드를 작성하도록 유도하며,
코드 리뷰 회의를 통해 오류를 직접 찾거나 잠재적으로 오류 가능성이 큰 코드르르 제거하고자 노력한다.

코드 리뷰 회의는 주로 개발 이후에 회의를 통해 이루어지기 때문에 오류가 뒤늦게 발견될 수도 있고,
선택적으로 실행하게 되는 경우도 있다.

코드 리뷰를 하나의 문화로 정착시키고 개발 프로세스의 일부로 만들기 위해 코드 리뷰를 강제할 시스템이 필요하다고 판단했다.

# 코드 리뷰 시스템을 통한 코드 리뷰
Gerrit 은 애초에 코드 리뷰를 자동화하고 강제하는 목적에 맞춰 만들어진 시스템이다.
수정한 코드를 적용하려면 일정 점수 이상의 코드 리뷰 점수를 획득해야 하도록 설정할 수 있다.
개발자가 수정한 코드를 중앙 저장소에 보내면 자동으로 지정된 리뷰어에게 알림이 가고, 
리뷰어는 온라인으로 리뷰를 진행한다.

Gerrit 도입으로 배포되기 전에 버그가 수정되는 경우가 많아졌다.
개발 당사자든 리뷰를 하는 팀원이든 읽기 좋은 코드를 만들기 위해 노력하게 됐다.

# 리뷰 통과 조건 설정
리뷰어가 요청받은 리뷰에 대한 의견을 작서앟고 점수를 부여하면 점수에 따라 해당 코드의 적용 가능 여부가 결정된다.
기본으로 +2 에서 -2까지 점수가 있으며, 네이버에서는 코드에 심각한 문제가 있어 적용하면 안되는 코드에 -2 를 부여한다.
-2 리뷰 의견이 있으면 대상 브랜치에 코드를 적용하지 않는다.

# 사용자 권한 관리
개발자의 역할에 차이가 있고 프로젝트 별로 담당자가 다르기 때문에 사용자의 권한을 관리해야 한다.
Gerrit 은 프로젝트와 역할데 따라 접근 권한을 관리할 수 있는 권한 관리 기능을 제공한다.

# 마치며
Gerrit 이 도입되면서 비정례적이고 선택적으로 실행되던 코드 리뷰가 필수적이고 정형화된 업무로 바뀌었다.
눈에 보이는 코드 품질의 향상뿐만 아니라 보이지 않는 의식의 변화를 가져왔다.


# 점수의 의미
- +2 : 적용을 승인한다.
- +1 : 수정할 내용은 없지만 다른 리뷰어의 승인이 필요하다.
- 0 : 의견만 작성한다.
- -1 : 적용하지 않는 것을 권장한다.
- -2 : 코드에 심각한 문제가 있어 적용하면 안 된다.

'+2' 를 부여한 리뷰 의견이 있어야 적용할 수 있다.
'-2' 를 부여한 리뷰 의견이 있다면 '+2' 를 부여한 리뷰 의견이 있어도 대상 브랜치에 적용할 수 없다.

# 푸쉬는 어디에?
푸쉬는 `refs/for/branch-name` 에 한다.

gerrit 은 프로젝트를 생성하고 git 저장소 관리를 gerrit 을 이용해서 하게 된다.
gerrit 에서 review 의 대상이 되는 것은 `refs/for/branch-name` 으로 들어온 푸시다.
예를 들어 아래와 같이 push 한다.
```sh
git push origin HEAD:refs/for/master
```

gerrit 의 bare 저장소인 gerrit/git 하위에 있는 refs 폴더를 보니 changes, heads, meta, tags 
네 개의 폴더가 있다. 근데 for 는 찾을 수 없다.
refs/for/* 로 넣으면 gerrit이 정리해서 git/refs/change 폴더에 넣는 것으로 보여진다.

# 각 리뷰는 commit 메시지에 있는 Change-id 로 구분한다.
gerrit 은 Change-Id 를 자동을 넣어주는 commit hook 을 제공한다.
아래 명령을 실행하면 change-id commit hook 이 만들어진다.
```bash
scp -p -P 29418 mytory@gerrit.domain.com:hooks/commit-msg .git/hooks/
chmod u+x .git/hooks/commit-msg
```
왜 commit name 이 있는데 그걸 놔두고 change-id 를 사용하는 것일까? 예를 들어,
리뷰가 빠꾸먹었다고 치자. 그래서 git commit --amend 로 commit 을 수정했다.
그러면 commit name 은 변한다. 그러나 change-id 는 변하지 않는다. 
그래서 gerrit 은 커밋이 예전 리뷰를 수정한 거라는 걸 알 수 있게 된다.


# ref
[Gerrit을 이용한 코드 리뷰 시스템 - Gerrit과 Git](https://d2.naver.com/helloworld/1859580)
    : Git 의 주요 개념
[Gerrit을 이용한 코드 리뷰 시스템 - 코드리뷰와 Gerrit](https://d2.naver.com/helloworld/6033708)
[gerrit 어디로 어떻게 푸시해야 하나](https://mytory.net/archives/12632)